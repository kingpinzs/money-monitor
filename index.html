<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Monitor</title>
    
    <!-- PWA Manifest and Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <link rel="apple-touch-icon" href="icons/icon-192x192.jpg">
    <link rel="icon" type="image/jpeg" href="icons/icon-192x192.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        html {
            overflow-x: hidden;
        }
        * {
            max-width: 100%;
            box-sizing: border-box;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        #side-menu { transition: transform 0.3s ease-in-out; overflow-y: auto;}
        #side-menu.open { transform: translateX(0); }
        .modal { transition: opacity 0.3s ease-in-out; }
        #toast, #level-up-toast { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .category-header .lucide-chevron-down { transition: transform 0.2s ease-in-out; }
        .health-bar-inner, #xp-bar { transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        .goal-icon-selector label {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .goal-icon-selector input:checked + label {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
        }
        /* Fixed header styles for mobile navigation fix */
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #111827;
            z-index: 40;
        }
        /* Only fix headers when the view is active (not hidden) */
        main:not(.hidden) .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 48rem; /* 768px - matches max-w-3xl */
            margin: 0 auto;
        }
        /* Add top padding to content areas to account for fixed header */
        .content-with-fixed-header {
            padding-top: 80px; /* Approximate header height */
        }
        /* Prevent horizontal overflow on all containers */
        .main-container {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }
        /* Ensure all text and elements wrap properly */
        .text-wrap {
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }
        .content-with-fixed-header {
            margin-top: 88px;
            margin-bottom: 88px;
        }
        div#goals-list {
            margin-top: 88px;
        }
        /* Fix grid layouts on mobile */
        @media (max-width: 640px) {
            .grid-mobile-fix {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }
        @media (max-width: 1024px) {
            .grid-mobile-fix {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

        }
        /* Mobile navigation optimizations for 375px and smaller screens */
        @media (max-width: 425px) {
            /* Bottom navigation mobile optimization */
            footer nav {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            footer nav button {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                min-width: 0;
            }
            footer nav button i {
                width: 1.25rem;
                height: 1.25rem;
            }
            footer nav button span {
                font-size: 0.6rem;
                line-height: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gray-800 overflow-x-hidden">

    <div class="max-w-3xl mx-auto bg-gray-900 text-white min-h-screen flex flex-col shadow-2xl main-container">

        <!-- Side Menu -->
        <div id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-gray-800 shadow-lg z-50 p-6 transform -translate-x-full border-r border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-xl font-bold">Menu</h2>
                <button id="close-menu-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <nav class="space-y-4 flex-1">
                <button id="add-income-menu-btn" class="w-full flex items-center gap-3 p-3 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold"><i data-lucide="plus-circle" class="w-5 h-5"></i><span>Add Income</span></button>
                <button id="add-bill-menu-btn" class="w-full flex items-center gap-3 p-3 rounded-lg bg-yellow-600 hover:bg-yellow-700 font-semibold"><i data-lucide="receipt" class="w-5 h-5"></i><span>Add Bill</span></button>
                <button id="add-debt-menu-btn" class="w-full flex items-center gap-3 p-3 rounded-lg bg-red-600 hover:bg-red-700 font-semibold"><i data-lucide="credit-card" class="w-5 h-5"></i><span>Add Debt</span></button>
                
                <div class="pt-6 border-t border-gray-700">
                     <button id="copy-month-btn" class="w-full flex items-center gap-3 p-3 rounded-lg bg-green-600 hover:bg-green-700 font-semibold mb-4"><i data-lucide="copy-plus" class="w-5 h-5"></i><span>Copy Month's Bills</span></button>
                     <label for="csv-importer" class="w-full flex items-center gap-3 p-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 font-semibold cursor-pointer mb-4"><i data-lucide="upload" class="w-5 h-5"></i><span>Import CSV</span></label>
                     <input type="file" id="csv-importer" class="hidden" accept=".csv">
                     <button id="learning-menu-btn" class="w-full flex items-center gap-3 p-3 rounded-lg bg-purple-600 hover:bg-purple-700 font-semibold"><i data-lucide="book-open" class="w-5 h-5"></i><span>Learning Hub</span></button>
                </div>
            </nav>
            <div class="mt-auto">
                <label class="text-sm text-gray-400">Current Month</label>
                <div class="mt-2 p-3 bg-gray-700 rounded-lg font-semibold" id="start-month-display"></div>
            </div>
        </div>
        <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

        <!-- Quick Overview View -->
        <main id="overview-view" class="flex-1 flex flex-col">
            <header class="sticky-header flex-shrink-0 flex items-center justify-between p-4 sm:p-6 border-b border-gray-700/50">
                 <button class="open-menu-btn hover:bg-gray-700 p-2 rounded-full"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <div class="flex-1 text-center">
                    <h1 class="text-xl font-bold" id="welcome-message">Quick Overview</h1>
                </div>
                <div class="flex items-center gap-2 w-32 justify-end">
                    <span id="streak-display" class="hidden items-center gap-1 text-orange-400 font-bold"><i data-lucide="flame"></i><span id="streak-count">0</span></span>
                    <i data-lucide="shield-check" class="w-6 h-6 text-yellow-400"></i>
                    <span id="level-display" class="font-bold text-lg">1</span>
                </div>
            </header>
            <div class="px-4 sm:px-6 pb-2">
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="xp-bar" class="bg-yellow-400 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 custom-scrollbar content-with-fixed-header">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 grid-mobile-fix">
                    <div class="bg-green-800/50 border border-green-700 p-4 rounded-lg"><p class="text-sm text-green-300">Month's Income</p><h2 id="overview-income" class="text-2xl font-bold"></h2></div>
                    <div class="bg-red-800/50 border border-red-700 p-4 rounded-lg"><p class="text-sm text-red-300">Month's Expenses</p><h2 id="overview-expenses" class="text-2xl font-bold"></h2></div>
                    <div class="bg-blue-800/50 border border-blue-700 p-4 rounded-lg"><p class="text-sm text-blue-300">Remaining Budget</p><h2 id="overview-remaining" class="text-2xl font-bold"></h2></div>
                </div>
                <div class="mb-6 bg-gray-800 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                         <h3 class="font-bold text-lg text-gray-300">Spending Health</h3>
                         <p id="spending-health-text" class="font-semibold"></p>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4">
                        <div id="spending-health-bar" class="health-bar-inner h-4 rounded-full"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 grid-mobile-fix">
                    <div class="bg-gray-800 p-4 rounded-lg flex flex-col">
                        <h3 class="font-bold text-lg mb-3 text-gray-300">Savings Goals</h3>
                        <div id="goal-suggestion" class="text-center p-4 flex-1 flex flex-col justify-center"></div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-3 text-gray-300">Expense Breakdown</h3>
                        <div class="h-48 w-full flex items-center justify-center">
                            <canvas id="expense-chart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- What If Calculator -->
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <h3 class="font-bold text-lg mb-3 text-gray-300">"What If" Calculator</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end grid-mobile-fix">
                        <div>
                            <label for="what-if-category" class="text-sm text-gray-400">If I cut my</label>
                            <select id="what-if-category" class="mt-1 w-full bg-gray-700 text-white rounded-lg p-2"></select>
                        </div>
                        <div>
                            <label for="what-if-percentage" class="text-sm text-gray-400">spending by</label>
                            <select id="what-if-percentage" class="mt-1 w-full bg-gray-700 text-white rounded-lg p-2">
                                <option>10%</option><option>15%</option><option>25%</option><option>50%</option>
                            </select>
                        </div>
                        <div>
                            <label for="what-if-goal" class="text-sm text-gray-400">I could reach my</label>
                            <select id="what-if-goal" class="mt-1 w-full bg-gray-700 text-white rounded-lg p-2"></select>
                        </div>
                    </div>
                    <p id="what-if-result" class="text-center mt-4 text-lg font-semibold text-teal-400 h-6"></p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-3 text-gray-300">Upcoming Bills</h3>
                    <div id="upcoming-bills-list" class="space-y-2"></div>
                </div>
            </div>
        </main>

        <!-- Monthly View -->
        <main id="monthly-view" class="flex-1 flex flex-col hidden">
            <header class="sticky-header flex-shrink-0 flex items-center justify-between p-4 sm:p-6 border-b border-gray-700/50">
                <button class="open-menu-btn hover:bg-gray-700 p-2 rounded-full"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="text-xl font-bold" id="current-month-header">This Month's Bills</h1>
                <div class="flex items-center gap-2">
                     <button id="prev-month-btn" class="hover:bg-gray-700 p-2 rounded-full"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                     <button id="next-month-btn" class="hover:bg-gray-700 p-2 rounded-full"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 custom-scrollbar content-with-fixed-header">
                <div class="space-y-4" id="transactions-list"></div>
            </div>
        </main>
        
        <!-- Goals View -->
        <main id="goals-view" class="flex-1 flex flex-col hidden">
             <header class="sticky-header flex-shrink-0 flex items-center justify-between p-4 sm:p-6 border-b border-gray-700/50">
                <button class="open-menu-btn hover:bg-gray-700 p-2 rounded-full"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="text-xl font-bold text-center">Savings Goals</h1>
                <button id="add-goal-btn" class="hover:bg-gray-700 p-2 rounded-full"><i data-lucide="plus" class="w-6 h-6"></i></button>
            </header>
            <div id="goals-list" class="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 custom-scrollbar content-with-fixed-header"></div>
        </main>

        <!-- Planning View -->
        <main id="planning-view" class="flex-1 flex flex-col hidden">
             <header class="sticky-header flex-shrink-0 flex items-center justify-between p-4 sm:p-6 border-b border-gray-700/50">
                <button class="open-menu-btn hover:bg-gray-700 p-2 rounded-full"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="text-xl font-bold text-center">Goal Planner</h1>
                <div class="w-10"></div>
            </header>
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 custom-scrollbar content-with-fixed-header">
                <div class="bg-gray-800 p-4 rounded-lg">
                    <label for="planning-goal-select" class="block text-sm font-medium text-gray-300 mb-2">Select a Goal to Plan:</label>
                    <select id="planning-goal-select" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div id="planning-content" class="mt-6 hidden">
                    <div class="bg-gray-800 p-4 rounded-lg mb-6">
                        <canvas id="planning-chart"></canvas>
                        <p id="planning-result-text" class="text-center mt-4 text-lg font-semibold text-green-400"></p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <label for="extra-savings-slider" class="block text-sm font-medium text-gray-300 mb-2">Extra Monthly Savings: <span id="extra-savings-value" class="font-bold text-white"></span></label>
                        <input type="range" id="extra-savings-slider" min="0" max="1000" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                 <div id="no-planning-goals" class="text-center py-16 text-gray-500">
                    <i data-lucide="info" class="w-12 h-12 mx-auto mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-300">No Active Goals</h3>
                    <p>Add a savings goal on the 'Goals' page to use the planner.</p>
                </div>
            </div>
        </main>

        <!-- Learning View -->
        <main id="learning-view" class="flex-1 flex flex-col hidden">
            <header class="sticky-header flex-shrink-0 flex items-center justify-between p-4 sm:p-6 border-b border-gray-700/50">
                <button class="open-menu-btn hover:bg-gray-700 p-2 rounded-full"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="text-xl font-bold text-center">Learning Hub</h1>
                <div class="w-10"></div>
            </header>
            <div class="flex-1 flex items-center justify-center text-center text-gray-500 p-4 pb-24 content-with-fixed-header">
                <div>
                    <i data-lucide="graduation-cap" class="w-16 h-16 mx-auto mb-4"></i>
                    <h2 class="text-xl font-bold text-gray-400">Coming Soon!</h2>
                    <p>The Learning Hub is under construction.</p>
                </div>
            </div>
        </main>

        <!-- Yearly Summary View -->
        <main id="yearly-view" class="flex-1 flex flex-col hidden">
             <header class="sticky-header flex-shrink-0 flex items-center justify-between p-4 sm:p-6 border-b border-gray-700/50">
                <button class="open-menu-btn hover:bg-gray-700 p-2 rounded-full"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="text-xl font-bold text-center" id="yearly-header">Yearly Summary</h1>
                <div class="flex items-center gap-2">
                     <button id="prev-year-btn" class="hover:bg-gray-700 p-2 rounded-full"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                     <button id="next-year-btn" class="hover:bg-gray-700 p-2 rounded-full"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 pb-24 custom-scrollbar content-with-fixed-header">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 grid-mobile-fix">
                    <div class="bg-green-800/50 border border-green-700 p-4 rounded-lg"><p class="text-sm text-green-300">Total Income</p><h2 id="total-income" class="text-2xl font-bold"></h2></div>
                    <div class="bg-red-800/50 border border-red-700 p-4 rounded-lg"><p class="text-sm text-red-300">Total Expenses</p><h2 id="total-expenses" class="text-2xl font-bold"></h2></div>
                    <div class="bg-blue-800/50 border border-blue-700 p-4 rounded-lg"><p class="text-sm text-blue-300">Net Savings</p><h2 id="net-savings" class="text-2xl font-bold"></h2></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-6"><canvas id="yearly-chart"></canvas></div>
                <div>
                    <h3 class="text-lg font-bold mb-3 text-gray-300">Monthly Breakdown</h3>
                    <div id="monthly-breakdown-list" class="space-y-2"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <footer class="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-sm border-t border-gray-700 z-40">
             <nav class="max-w-3xl mx-auto flex justify-around items-center h-20  px-2 overflow-x-hidden">
                <button id="overview-view-btn" class="flex flex-col items-center text-blue-400 font-semibold px-4 py-2"><i data-lucide="layout-grid" class="w-6 h-6 mb-1"></i><span class="text-xs" style="font-size: 0.75rem;">Overview</span></button>
                <button id="monthly-view-btn" class="flex flex-col items-center text-gray-400 hover:text-white transition-colors px-4 py-2"><i data-lucide="wallet" class="w-6 h-6 mb-1"></i><span class="text-xs" style="font-size: 0.75rem;">Monthly</span></button>
                <button id="goals-view-btn" class="flex flex-col items-center text-gray-400 hover:text-white transition-colors px-4 py-2"><i data-lucide="target" class="w-6 h-6 mb-1"></i><span class="text-xs" style="font-size: 0.75rem;">Goals</span></button>
                <button id="planning-view-btn" class="flex flex-col items-center text-gray-400 hover:text-white transition-colors px-4 py-2"><i data-lucide="sliders-horizontal" class="w-6 h-6 mb-1"></i><span class="text-xs" style="font-size: 0.75rem;">Planner</span></button>
                <button id="yearly-view-btn" class="flex flex-col items-center text-gray-400 hover:text-white transition-colors px-4 py-2"><i data-lucide="calendar-days" class="w-6 h-6 mb-1"></i><span class="text-xs" style="font-size: 0.75rem;">Yearly</span></button>
            </nav>
        </footer>
    </div>

    <!-- Modals -->
    <div id="add-transaction-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="bg-gray-800 w-full max-w-md rounded-2xl shadow-xl p-6 border border-gray-700"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white" id="modal-title">Add Transaction</h2><button id="close-modal-btn"><i data-lucide="x" class="w-6 h-6 text-gray-400 hover:text-white"></i></button></div><form id="transaction-form" class="space-y-4"><input type="hidden" id="transaction-id" name="id"><div><label for="transaction-type" class="block text-sm font-medium text-gray-300 mb-1">Type</label><select id="transaction-type" name="type" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"><option value="bill">Bill</option><option value="income">Income</option><option value="debt">Debt</option></select></div><div><label for="transaction-description" class="block text-sm font-medium text-gray-300 mb-1">Description</label><input type="text" id="transaction-description" name="description" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="e.g., Rent, Paycheck"></div><div><label for="transaction-amount" class="block text-sm font-medium text-gray-300 mb-1">Amount</label><input type="number" id="transaction-amount" name="amount" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="0.00" step="0.01"></div><div id="category-container"><label for="transaction-category" class="block text-sm font-medium text-gray-300 mb-1">Category</label><select id="transaction-category" name="category" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"><option value="essential">Essential Living Expense</option><option value="subscription">Subscriptions & Memberships</option><option value="discretionary">Discretionary Spending</option><option value="other">Other</option></select></div><div><label for="transaction-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label><input type="date" id="transaction-date" name="date" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"></div><div class="flex justify-between items-center w-full pt-4"><button type="button" id="delete-btn" class="px-6 py-2 rounded-lg bg-red-800 hover:bg-red-700 text-red-200 font-semibold hidden">Delete</button><div class="flex gap-3 ml-auto"><button type="button" id="cancel-modal-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancel</button><button type="submit" id="save-btn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">Save</button></div></div></form></div></div>
    <div id="copy-month-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 hidden opacity-0"> <div class="bg-gray-800 w-full max-w-md rounded-2xl shadow-xl p-6 border border-gray-700"> <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-bold text-white">Copy Bills To...</h2> <button id="close-copy-modal-btn"><i data-lucide="x" class="w-6 h-6 text-gray-400 hover:text-white"></i></button> </div> <form id="copy-month-form"> <p class="text-gray-400 text-sm mb-4">Select months to copy transactions from <span id="copy-source-month" class="font-semibold text-white"></span>.</p> <div class="mb-4"> <label for="years-to-copy-input" class="block text-sm font-medium text-gray-300 mb-1">Number of years to copy forward</label> <input type="number" id="years-to-copy-input" name="years" value="1" min="1" max="10" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"> </div> <div id="months-checkbox-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-48 overflow-y-auto custom-scrollbar pr-2"></div> <div class="mt-4"> <label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer"> <input type="checkbox" id="select-all-months" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-600"> <span>Select All Months</span> </label> </div> <div class="flex justify-end gap-3 pt-6"> <button type="button" id="cancel-copy-modal-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancel</button> <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700">Copy</button> </div> </form> </div> </div>
    <div id="csv-confirmation-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 hidden opacity-0"> <div class="bg-gray-800 w-full max-w-lg rounded-2xl shadow-xl p-6 border border-gray-700"> <h2 class="text-xl font-bold text-white mb-4">Confirm Import</h2> <p class="text-gray-400 mb-4">Found <strong id="csv-record-count" class="text-white">0</strong> transactions. Do you want to import them?</p> <div class="max-h-60 overflow-y-auto custom-scrollbar p-2 bg-gray-900 rounded-lg mb-4" id="csv-preview-list"></div> <div class="flex justify-end gap-3 pt-4"> <button type="button" id="cancel-csv-import-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancel</button> <button type="button" id="confirm-csv-import-btn" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Import</button> </div> </div> </div>
    <div id="goal-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl shadow-xl p-6 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white" id="goal-modal-title">Add Goal</h2>
                <button id="close-goal-modal-btn"><i data-lucide="x" class="w-6 h-6 text-gray-400 hover:text-white"></i></button>
            </div>
            <form id="goal-form" class="space-y-4">
                <input type="hidden" id="goal-id" name="id">
                <div><label for="goal-type" class="block text-sm font-medium text-gray-300 mb-1">Goal Type</label><select id="goal-type" name="type" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"><option value="savings">Savings Goal</option><option value="debt">Debt Payoff Goal</option></select></div>
                <div> <label for="goal-name" class="block text-sm font-medium text-gray-300 mb-1">Goal Name</label> <input type="text" id="goal-name" name="name" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="e.g., Hawaii Vacation"> </div>
                <div> <label for="goal-amount" class="block text-sm font-medium text-gray-300 mb-1">Total Amount</label> <input type="number" id="goal-amount" name="amount" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="2500.00" step="0.01"> </div>
                <div> <label for="goal-saved" class="block text-sm font-medium text-gray-300 mb-1">Amount Already Saved/Paid</label> <input type="number" id="goal-saved" name="saved" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="100.00" step="0.01" value="0"> </div>
                <div> <label for="goal-date" class="block text-sm font-medium text-gray-300 mb-1">Target Date</label> <input type="date" id="goal-date" name="date" required class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500"> </div>
                <div>
                    <label for="goal-icon" class="block text-sm font-medium text-gray-300 mb-2">Icon</label>
                    <div id="goal-icon-selector" class="goal-icon-selector grid grid-cols-5 gap-3">
                        <!-- Icons will be populated by JS -->
                    </div>
                </div>
                <div class="flex justify-between items-center w-full pt-4"> <button type="button" id="delete-goal-btn" class="px-6 py-2 rounded-lg bg-red-800 hover:bg-red-700 text-red-200 font-semibold hidden">Delete</button> <div class="flex gap-3 ml-auto"> <button type="button" id="cancel-goal-modal-btn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancel</button> <button type="submit" id="save-goal-btn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">Save Goal</button> </div> </div>
            </form>
        </div>
    </div>
    <div id="victory-modal" class="modal fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100] hidden opacity-0 text-center">
        <div>
            <h1 class="text-6xl font-bold text-yellow-400 animate-pulse">VICTORY!</h1>
            <p class="text-xl text-white mt-4">You defeated the <strong id="victory-debt-name"></strong> debt!</p>
            <p class="mt-2 text-3xl">ðŸŽ‰ ðŸŽ‰ ðŸŽ‰</p>
        </div>
    </div>
    <div id="subscription-review-modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-gray-800 w-full max-w-lg rounded-2xl shadow-xl p-6 border border-gray-700">
            <div class="text-center">
                <i data-lucide="receipt" class="w-12 h-12 mx-auto text-yellow-400 mb-4"></i>
                <h2 class="text-xl font-bold text-white mb-2">Quarterly Subscription Review</h2>
                <p class="text-gray-400 mb-4">In the last 90 days, you've spent <strong id="subscription-total" class="text-white"></strong> on subscriptions.</p>
            </div>
            <div class="max-h-60 overflow-y-auto custom-scrollbar p-2 bg-gray-900 rounded-lg mb-4" id="subscription-list"></div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" id="close-subscription-modal-btn" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700">Got it!</button>
            </div>
        </div>
    </div>
    <div id="level-up-toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-yellow-500 text-black px-6 py-3 rounded-lg shadow-lg transform -translate-y-20 opacity-0 flex items-center gap-3">
        <i data-lucide="star"></i>
        <span class="font-bold"></span>
    </div>
    <div id="toast" class="fixed bottom-24 sm:bottom-10 right-10 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0"></div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let goals = JSON.parse(localStorage.getItem('goals')) || [];
            let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { level: 1, xp: 0, savingsStreak: 0, lastContributionDate: null, lastSubscriptionReview: null };
            let collapsedCategories = JSON.parse(localStorage.getItem('collapsedCategories')) || {};
            let currentDate = new Date(); currentDate.setDate(1);
            let summaryYear = new Date().getFullYear();
            let yearlyChart = null;
            let expenseChart = null;
            let planningChart = null;
            let transactionsToImport = [];
            const XP_VALUES = { ADD_TRANSACTION: 5, PAY_BILL: 10, ADD_TO_GOAL: 25, WEEKLY_STREAK: 50 };
            const getXpForNextLevel = (level) => 100 + (level - 1) * 50;

            const saveData = () => {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('goals', JSON.stringify(goals));
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                localStorage.setItem('collapsedCategories', JSON.stringify(collapsedCategories));
            };

            // --- DOM ELEMENTS ---
            const sideMenu = document.getElementById('side-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const openMenuBtns = document.querySelectorAll('.open-menu-btn');
            const overviewView = document.getElementById('overview-view');
            const monthlyView = document.getElementById('monthly-view');
            const yearlyView = document.getElementById('yearly-view');
            const goalsView = document.getElementById('goals-view');
            const planningView = document.getElementById('planning-view');
            const learningView = document.getElementById('learning-view');
            const overviewViewBtn = document.getElementById('overview-view-btn');
            const monthlyViewBtn = document.getElementById('monthly-view-btn');
            const yearlyViewBtn = document.getElementById('yearly-view-btn');
            const goalsViewBtn = document.getElementById('goals-view-btn');
            const planningViewBtn = document.getElementById('planning-view-btn');
            const transactionsList = document.getElementById('transactions-list');
            const addGoalBtn = document.getElementById('add-goal-btn');
            const goalModal = document.getElementById('goal-modal');
            const goalForm = document.getElementById('goal-form');
            const csvImporter = document.getElementById('csv-importer');
            const csvConfirmationModal = document.getElementById('csv-confirmation-modal');

            // --- HELPER FUNCTIONS ---
            const formatCurrency = (amount) => `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const showToast = (message, type = 'success') => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `fixed bottom-24 sm:bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 10);
                setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
            };
            const showLevelUpToast = (message) => {
                const toast = document.getElementById('level-up-toast');
                toast.querySelector('span').textContent = message;
                toast.classList.remove('-translate-y-20', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('-translate-y-20', 'opacity-0');
                }, 4000);
            };
            const toggleModal = (modalElement, open) => {
                if(open) {
                    modalElement.classList.remove('hidden');
                    setTimeout(() => modalElement.classList.remove('opacity-0'), 10);
                } else {
                    modalElement.classList.add('opacity-0');
                    setTimeout(() => modalElement.classList.add('hidden'), 300);
                }
            };
            const toggleMenu = (open) => {
                if (open) { sideMenu.classList.add('open'); menuOverlay.classList.remove('hidden'); } 
                else { sideMenu.classList.remove('open'); menuOverlay.classList.add('hidden'); }
            };
            const isSameWeek = (d1Str, d2) => {
                const d1 = new Date(d1Str);
                const firstDayOfWeek = new Date(d1.setDate(d1.getDate() - d1.getDay()));
                firstDayOfWeek.setHours(0,0,0,0);
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(lastDayOfWeek.getDate() + 6);
                lastDayOfWeek.setHours(23,59,59,999);
                return d2 >= firstDayOfWeek && d2 <= lastDayOfWeek;
            };

            // --- GAMIFICATION LOGIC ---
            const addXp = (amount) => {
                userProfile.xp += amount;
                const xpForNextLevel = getXpForNextLevel(userProfile.level);
                if (userProfile.xp >= xpForNextLevel) {
                    userProfile.level++;
                    userProfile.xp -= xpForNextLevel;
                    showLevelUpToast(`Level Up! You've reached Level ${userProfile.level}!`);
                }
                updateProfileUI();
                saveData();
            };
            const updateProfileUI = () => {
                document.getElementById('level-display').textContent = userProfile.level;
                const xpForNextLevel = getXpForNextLevel(userProfile.level);
                const xpPercentage = (userProfile.xp / xpForNextLevel) * 100;
                document.getElementById('xp-bar').style.width = `${xpPercentage}%`;
                const streakDisplay = document.getElementById('streak-display');
                if (userProfile.savingsStreak > 0) {
                    document.getElementById('streak-count').textContent = userProfile.savingsStreak;
                    streakDisplay.classList.remove('hidden');
                    streakDisplay.classList.add('flex');
                } else {
                    streakDisplay.classList.add('hidden');
                }
                lucide.createIcons();
            };
            const updateSavingsStreak = () => {
                const now = new Date();
                if (userProfile.lastContributionDate && isSameWeek(userProfile.lastContributionDate, now)) return;
                userProfile.savingsStreak++;
                userProfile.lastContributionDate = now.toISOString();
                showToast(`Savings streak: ${userProfile.savingsStreak} weeks! +${XP_VALUES.WEEKLY_STREAK} XP`);
                addXp(XP_VALUES.WEEKLY_STREAK);
                updateProfileUI();
            };
            
            // --- VIEW MANAGEMENT ---
            const setActiveView = (viewName) => {
                const views = { overview: overviewView, monthly: monthlyView, yearly: yearlyView, goals: goalsView, planning: planningView, learning: learningView };
                const buttons = { overview: overviewViewBtn, monthly: monthlyViewBtn, yearly: yearlyViewBtn, goals: goalsViewBtn, planning: planningViewBtn };
                for (const key in views) {
                    views[key].classList.toggle('hidden', key !== viewName);
                    if (buttons[key]) {
                        buttons[key].classList.toggle('text-blue-400', key === viewName);
                        buttons[key].classList.toggle('font-semibold', key === viewName);
                        buttons[key].classList.toggle('text-gray-400', key !== viewName);
                    }
                }
                if (viewName === 'yearly') renderYearlySummary();
                else if (viewName === 'monthly') renderMonthlyTransactions();
                else if (viewName === 'goals') renderGoalsPage();
                else if (viewName === 'planning') renderPlanningPage();
                else if (viewName === 'overview') renderQuickOverview();
                lucide.createIcons();
            };

            // --- WELCOME MESSAGE ---
            const setWelcomeMessage = () => {
                const hour = new Date().getHours();
                const welcomeEl = document.getElementById('welcome-message');
                if (hour < 12) welcomeEl.textContent = 'Good Morning!';
                else if (hour < 18) welcomeEl.textContent = 'Good Afternoon!';
                else welcomeEl.textContent = 'Good Evening!';
            };

            // --- SMART ASSISTANT LOGIC ---
            const checkForSubscriptionReview = () => {
                const now = new Date();
                const lastReview = userProfile.lastSubscriptionReview ? new Date(userProfile.lastSubscriptionReview) : null;
                const ninetyDaysAgo = new Date(new Date().setDate(now.getDate() - 90));

                if (!lastReview || lastReview < ninetyDaysAgo) {
                    showSubscriptionReviewModal();
                }
            };

            const showSubscriptionReviewModal = () => {
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

                const subscriptions = transactions.filter(t => t.category === 'subscription' && new Date(t.date) > ninetyDaysAgo);
                if (subscriptions.length === 0) {
                    userProfile.lastSubscriptionReview = new Date().toISOString();
                    saveData();
                    return;
                }

                const total = subscriptions.reduce((sum, t) => sum + t.amount, 0);
                document.getElementById('subscription-total').textContent = formatCurrency(total);
                document.getElementById('subscription-list').innerHTML = subscriptions
                    .map(t => `<div class="text-sm p-2 flex justify-between"><span>${t.description}</span><span>${formatCurrency(t.amount)}</span></div>`)
                    .join('');

                toggleModal(document.getElementById('subscription-review-modal'), true);
                lucide.createIcons();
            };

            const calculateWhatIfScenario = () => {
                const category = document.getElementById('what-if-category').value;
                const percentage = parseInt(document.getElementById('what-if-percentage').value) / 100;
                const goalId = document.getElementById('what-if-goal').value;
                const resultEl = document.getElementById('what-if-result');

                const goal = goals.find(g => g.id == goalId);
                if (!goal) { resultEl.textContent = ""; return; }

                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                
                const recentSpending = transactions.filter(t => t.category === category && new Date(t.date) >= sixMonthsAgo);
                const monthlyAverage = recentSpending.reduce((sum, t) => sum + t.amount, 0) / 6;

                if (monthlyAverage === 0) {
                    resultEl.textContent = `No recent spending in '${category}'.`; return;
                }

                const monthlySavings = monthlyAverage * percentage;
                const needed = goal.amount - goal.saved;

                const now = new Date();
                const targetDate = new Date(goal.date);
                const monthsToTarget = Math.max(1, (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth()));
                const idealMonthlySavings = needed > 0 ? needed / monthsToTarget : 0;
                
                const newTotalMonthlySavings = idealMonthlySavings + monthlySavings;
                const newMonthsToTarget = needed > 0 ? Math.ceil(needed / newTotalMonthlySavings) : 0;

                const daysSaved = (monthsToTarget - newMonthsToTarget) * 30.44; // Avg days in month

                if(daysSaved <= 0) {
                     resultEl.textContent = `It would make a small difference.`;
                } else {
                     resultEl.textContent = `You'd reach it ${Math.round(daysSaved)} days sooner!`;
                }
            };
            const renderWhatIfCalculator = () => {
                const categorySelect = document.getElementById('what-if-category');
                const goalSelect = document.getElementById('what-if-goal');
                
                categorySelect.innerHTML = `<option value="discretionary">Discretionary</option><option value="subscription">Subscriptions</option>`;
                
                const activeGoals = goals.filter(g => g.type === 'savings' && g.saved < g.amount);
                goalSelect.innerHTML = activeGoals.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

                if(activeGoals.length === 0) {
                    document.getElementById('what-if-result').textContent = "Add a goal to get started!";
                    return;
                }
                
                ['what-if-category', 'what-if-percentage', 'what-if-goal'].forEach(id => {
                    document.getElementById(id).addEventListener('change', calculateWhatIfScenario);
                });
                calculateWhatIfScenario();
            };
            
            // --- RENDER FUNCTIONS (ALL VIEWS) ---
            const renderQuickOverview = () => { setWelcomeMessage(); const currentMonthTransactions = transactions.filter(t => new Date(t.date + 'T00:00:00').getFullYear() === currentDate.getFullYear() && new Date(t.date + 'T00:00:00').getMonth() === currentDate.getMonth()); const income = currentMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const expenses = currentMonthTransactions.filter(t => t.type !== 'income').reduce((sum, t) => sum + t.amount, 0); const remaining = income - expenses; document.getElementById('overview-income').textContent = formatCurrency(income); document.getElementById('overview-expenses').textContent = formatCurrency(expenses); const remainingEl = document.getElementById('overview-remaining'); remainingEl.textContent = formatCurrency(remaining); remainingEl.classList.toggle('text-red-400', remaining < 0); remainingEl.classList.toggle('text-green-400', remaining >= 0); renderSpendingHealthBar(income, expenses); renderExpenseChart(currentMonthTransactions); renderUpcomingBills(currentMonthTransactions); renderGoalSuggestion(remaining); renderWhatIfCalculator(); };
            const renderSpendingHealthBar = (income, expenses) => { const healthBar = document.getElementById('spending-health-bar'); const healthText = document.getElementById('spending-health-text'); if (income === 0) { healthBar.style.width = '0%'; healthText.textContent = 'No income yet'; healthText.className = 'font-semibold text-gray-400'; return; } const spentPercentage = (expenses / income) * 100; healthBar.style.width = `${Math.min(spentPercentage, 100)}%`; if (spentPercentage <= 50) { healthBar.className = 'health-bar-inner h-4 rounded-full bg-green-500'; healthText.textContent = 'Looking Good!'; healthText.className = 'font-semibold text-green-400'; } else if (spentPercentage <= 85) { healthBar.className = 'health-bar-inner h-4 rounded-full bg-yellow-500'; healthText.textContent = 'Be Mindful'; healthText.className = 'font-semibold text-yellow-400'; } else { healthBar.className = 'health-bar-inner h-4 rounded-full bg-red-500'; healthText.textContent = 'Over Budget!'; healthText.className = 'font-semibold text-red-400'; } };
            const renderExpenseChart = (currentMonthTransactions) => { const ctx = document.getElementById('expense-chart').getContext('2d'); const expenseData = currentMonthTransactions .filter(t => t.type !== 'income') .reduce((acc, t) => { const categoryName = t.category.charAt(0).toUpperCase() + t.category.slice(1); acc[categoryName] = (acc[categoryName] || 0) + t.amount; return acc; }, {}); const labels = Object.keys(expenseData); const data = Object.values(expenseData); if (expenseChart) expenseChart.destroy(); expenseChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['#1d4ed8', '#b91c1c', '#d97706', '#65a30d', '#4b5563'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db' } } } } }); };
            const renderUpcomingBills = (currentMonthTransactions) => { const upcomingList = document.getElementById('upcoming-bills-list'); const now = new Date(); now.setHours(0,0,0,0); const upcoming = currentMonthTransactions .filter(t => t.type !== 'income' && t.status !== 'paid' && new Date(t.date + 'T00:00:00') >= now) .sort((a,b) => new Date(a.date) - new Date(b.date)) .slice(0, 3); if (upcoming.length === 0) { upcomingList.innerHTML = `<div class="text-center py-8 text-gray-500">No upcoming bills this month!</div>`; return; } upcomingList.innerHTML = upcoming.map(t => `<div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center"><p>${t.description}</p><div><p class="font-bold">${formatCurrency(t.amount)}</p><p class="text-xs text-gray-400 text-right">Due ${new Date(t.date + 'T00:00:00').toLocaleDateString()}</p></div></div>`).join(''); };
            const renderGoalSuggestion = (remainingBudget) => { const suggestionEl = document.getElementById('goal-suggestion'); const now = new Date(); let totalMonthlyContribution = 0; goals.forEach(goal => { const targetDate = new Date(goal.date + 'T00:00:00'); if(targetDate > now && goal.saved < goal.amount) { const monthsRemaining = (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth()); if (monthsRemaining > 0) { totalMonthlyContribution += (goal.amount - goal.saved) / monthsRemaining; } else { totalMonthlyContribution += (goal.amount - goal.saved); } } }); if (totalMonthlyContribution === 0) { suggestionEl.innerHTML = `<p class="text-gray-400">No active goals. Add one on the Goals page!</p>`; return; } const canSave = remainingBudget >= totalMonthlyContribution; suggestionEl.innerHTML = `<p class="text-gray-300">You need to save <strong class="text-white">${formatCurrency(totalMonthlyContribution)}</strong> this month for your goals.</p><p class="mt-2 text-lg ${canSave ? 'text-green-400' : 'text-red-400'} font-semibold">${canSave ? "You're on track!" : "Budget is tight!"}</p><p class="text-xs text-gray-400 mt-1">${canSave ? `You have ${formatCurrency(remainingBudget - totalMonthlyContribution)} extra after saving.` : `You are short by ${formatCurrency(totalMonthlyContribution - remainingBudget)}.`}</p>`; if(remainingBudget > 0 && goals.some(g => g.saved < g.amount)) { suggestionEl.innerHTML += `<button id="fuel-goals-btn" class="mt-4 w-full flex items-center justify-center gap-2 p-3 rounded-lg bg-teal-600 hover:bg-teal-700 font-semibold transition-colors"><i data-lucide="fuel" class="w-5 h-5"></i>Add Fuel to Your Goals!</button>`; document.getElementById('fuel-goals-btn').addEventListener('click', () => fuelGoals(remainingBudget)); lucide.createIcons(); } };
            const fuelGoals = (amountToSave) => { let remainingToDistribute = amountToSave; const sortedGoals = goals.filter(g => g.saved < g.amount).sort((a,b) => new Date(a.date) - new Date(b.date)); sortedGoals.forEach(goal => { if (remainingToDistribute <= 0) return; const needed = goal.amount - goal.saved; const contribution = Math.min(needed, remainingToDistribute); goal.saved += contribution; remainingToDistribute -= contribution; }); addXp(XP_VALUES.ADD_TO_GOAL * sortedGoals.length); updateSavingsStreak(); saveData(); showToast(`${formatCurrency(amountToSave)} added to your goals!`, 'success'); renderQuickOverview(); renderGoalsPage(); };
            const renderMonthlyTransactions = () => { transactionsList.innerHTML = ''; document.getElementById('current-month-header').textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate); document.getElementById('start-month-display').textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate); const currentMonthTransactions = transactions.filter(t => new Date(t.date + 'T00:00:00').getFullYear() === currentDate.getFullYear() && new Date(t.date + 'T00:00:00').getMonth() === currentDate.getMonth()).sort((a,b) => new Date(a.date) - new Date(b.date)); if (currentMonthTransactions.length === 0) { transactionsList.innerHTML = `<div class="text-center py-16 bg-gray-800 rounded-lg"><i data-lucide="wind" class="w-12 h-12 mx-auto text-gray-500 mb-4"></i><h3 class="text-lg font-semibold text-gray-300">Nothing here yet</h3><p class="text-gray-400">Add an income, bill, or debt to get started.</p></div>`; lucide.createIcons(); return; } let grandTotalBills = 0; const transactionGroups = { income: [], essential: [], subscription: [], discretionary: [], other: [] }; currentMonthTransactions.forEach(t => { if (t.type === 'income') { transactionGroups.income.push(t); } else { (transactionGroups[t.category] || transactionGroups.other).push(t); grandTotalBills += t.amount; } }); const categoryTitles = { income: 'Income', essential: 'Essential Living Expenses', subscription: 'Subscriptions & Memberships', discretionary: 'Discretionary Spending', other: 'Other Bills & Debts' }; const createTransactionElement = (t) => { const statusStyles = { paid: { text: 'Paid', bg: 'bg-green-500/20', textClr: 'text-green-400' }, unpaid: { text: 'Unpaid', bg: 'bg-gray-500/20', textClr: 'text-gray-300' }, 'due-soon': { text: 'Due Soon', bg: 'bg-red-500/20', textClr: 'text-red-400' } }; const typeIcons = { bill: 'receipt', debt: 'credit-card', income: 'trending-up' }; const status = statusStyles[t.status] || statusStyles['unpaid']; const formatDate = (ds) => new Date(ds + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); return `<div class="group bg-gray-800 rounded-lg p-4 flex items-center justify-between transition-all hover:bg-gray-700/50 relative"><div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"><button data-id="${t.id}" class="edit-btn p-1.5 hover:bg-gray-600 rounded-md"><i data-lucide="pencil" class="w-4 h-4 text-gray-400 pointer-events-none"></i></button></div><div class="flex items-center gap-4"><div class="p-3 bg-gray-700 rounded-full"><i data-lucide="${typeIcons[t.type]}" class="w-5 h-5"></i></div><div><p class="font-semibold">${t.description}</p><p class="text-sm text-gray-400">Due ${formatDate(t.date)}</p></div></div><div class="text-right"><p class="font-bold text-lg ${t.type === 'income' ? 'text-green-400' : 'text-white'}">${formatCurrency(t.amount)}</p>${t.type !== 'income' ? `<button data-id="${t.id}" class="toggle-paid-btn text-xs font-semibold px-2 py-1 rounded-full mt-1 ${status.bg} ${status.textClr} transition-colors hover:opacity-80">${status.text}</button>` : ''}</div></div>`; }; for (const key in categoryTitles) { if (transactionGroups[key] && transactionGroups[key].length > 0) { const isCollapsed = collapsedCategories[key] || false; const categoryTotal = transactionGroups[key].reduce((sum, t) => sum + t.amount, 0); const lastMonth = new Date(currentDate); lastMonth.setMonth(lastMonth.getMonth() - 1); const lastMonthTotal = transactions.filter(t => new Date(t.date).getFullYear() === lastMonth.getFullYear() && new Date(t.date).getMonth() === lastMonth.getMonth() && t.category === key).reduce((sum, t) => sum + t.amount, 0); let alertIcon = ''; if (lastMonthTotal > 0 && categoryTotal > lastMonthTotal * 1.25) { alertIcon = `<i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-400 ml-2" title="Spending is higher than last month"></i>`; } transactionsList.innerHTML += `<div class="mt-4"><div class="category-header cursor-pointer flex justify-between items-center p-2 rounded-md hover:bg-gray-700/50" data-category-key="${key}"><div class="flex items-center gap-2"><i data-lucide="chevron-down" class="w-5 h-5 ${isCollapsed ? '-rotate-90' : ''}"></i><h3 class="font-bold text-lg text-gray-300">${categoryTitles[key]}</h3>${alertIcon}</div><span class="font-semibold ${key === 'income' ? 'text-green-400' : 'text-white'}">${formatCurrency(categoryTotal)}</span></div><div class="pl-5 space-y-2 mt-2 ${isCollapsed ? 'hidden' : ''}">${transactionGroups[key].map(createTransactionElement).join('')}</div></div>`; } } transactionsList.innerHTML += `<div class="mt-8 p-4 bg-blue-900/50 rounded-lg flex justify-between items-center border border-blue-800"><span class="font-bold text-lg text-blue-300">Month's Total Bills:</span><span class="font-bold text-xl text-white">${formatCurrency(grandTotalBills)}</span></div>`; lucide.createIcons(); };
            const renderYearlySummary = () => { document.getElementById('yearly-header').textContent = `Summary for ${summaryYear}`; const yearlyTransactions = transactions.filter(t => new Date(t.date + 'T00:00:00').getFullYear() === summaryYear); let totalIncome = 0; let totalExpenses = 0; const monthlyData = Array(12).fill(0).map(() => ({ income: 0, expenses: 0 })); yearlyTransactions.forEach(t => { const month = new Date(t.date + 'T00:00:00').getMonth(); if (t.type === 'income') { totalIncome += t.amount; monthlyData[month].income += t.amount; } else { totalExpenses += t.amount; monthlyData[month].expenses += t.amount; } }); const netSavings = totalIncome - totalExpenses; document.getElementById('total-income').textContent = formatCurrency(totalIncome); document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses); const netSavingsEl = document.getElementById('net-savings'); netSavingsEl.textContent = formatCurrency(netSavings); netSavingsEl.className = `text-2xl font-bold ${netSavings < 0 ? 'text-red-400' : 'text-green-400'}`; renderYearlyChart(monthlyData); renderMonthlyBreakdown(monthlyData); };
            const renderYearlyChart = (monthlyData) => { const ctx = document.getElementById('yearly-chart').getContext('2d'); if (yearlyChart) yearlyChart.destroy(); yearlyChart = new Chart(ctx, { type: 'bar', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], datasets: [ { label: 'Income', data: monthlyData.map(m => m.income), backgroundColor: 'rgba(59, 130, 246, 0.7)' }, { label: 'Expenses', data: monthlyData.map(m => m.expenses), backgroundColor: 'rgba(239, 68, 68, 0.7)' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } }, scales: { y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#9ca3af' }, grid: { display: false } } } } }); };
            const renderMonthlyBreakdown = (monthlyData) => { const breakdownList = document.getElementById('monthly-breakdown-list'); breakdownList.innerHTML = ''; const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; let hasData = false; monthlyData.forEach((data, index) => { if (data.income > 0 || data.expenses > 0) { hasData = true; const net = data.income - data.expenses; breakdownList.innerHTML += `<div class="bg-gray-800 p-3 rounded-lg grid grid-cols-3 items-center gap-4 text-sm"><strong class="text-white col-span-1">${monthNames[index]}</strong><div class="col-span-2 grid grid-cols-3 gap-2 text-right"><span class="text-green-400">${formatCurrency(data.income)}</span><span class="text-red-400">${formatCurrency(data.expenses)}</span><span class="font-semibold ${net >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(net)}</span></div></div>`; } }); if (!hasData) { breakdownList.innerHTML = `<div class="text-center py-8 text-gray-500">No data for ${summaryYear}</div>` } else { breakdownList.insertAdjacentHTML('afterbegin', `<div class="p-3 rounded-lg grid grid-cols-3 items-center gap-4 text-xs font-bold text-gray-400"><span class="col-span-1">Month</span><div class="col-span-2 grid grid-cols-3 gap-2 text-right"><span>Income</span><span>Expenses</span><span>Net</span></div></div>`); } };
            const renderGoalsPage = () => { const goalsListEl = document.getElementById('goals-list'); if (goals.length === 0) { goalsListEl.innerHTML = `<div class="text-center py-16 text-gray-500"><i data-lucide="target" class="w-12 h-12 mx-auto mb-4"></i><h3 class="text-lg font-semibold text-gray-300">No Goals Yet</h3><p>Click the '+' to add a new savings goal.</p></div>`; lucide.createIcons(); return; } goalsListEl.innerHTML = goals.map(goal => { if(goal.type === 'debt'){ const healthPercent = Math.max(0, 100 - ((goal.amount > 0 ? goal.saved / goal.amount : 1) * 100)); return `<div class="bg-gray-800 p-4 rounded-lg mb-4 goal-item cursor-pointer" data-id="${goal.id}"><h4 class="text-xl font-bold text-center text-red-400 mb-2">BOSS: ${goal.name}</h4><div class="w-full bg-gray-700 rounded-full h-6 border-2 border-red-900"><div class="bg-red-600 h-full rounded-full health-bar-inner" style="width: ${healthPercent}%"></div></div><div class="flex justify-between text-sm mt-1"><span>${formatCurrency(goal.saved)} Paid Off</span><span>${formatCurrency(goal.amount)} Total</span></div></div>`; } const percent = Math.min(100, (goal.amount > 0 ? (goal.saved / goal.amount) * 100 : 100)); const now = new Date(); const targetDate = new Date(goal.date + 'T00:00:00'); let monthlyContribution = 0; if(targetDate > now && goal.saved < goal.amount) { const monthsRemaining = Math.max(1, (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth())); monthlyContribution = (goal.amount - goal.saved) / monthsRemaining; } const onTrack = monthlyContribution > 0; return `<div class="bg-gray-800 p-4 rounded-lg mb-4 goal-item cursor-pointer" data-id="${goal.id}"><div class="flex justify-between items-start"><div class="flex items-center gap-4"><div class="p-3 bg-gray-700 rounded-full"><i data-lucide="${goal.icon || 'target'}" class="w-6 h-6 text-indigo-300"></i></div><div><h4 class="text-xl font-bold">${goal.name}</h4><p class="text-sm text-gray-400">Target: ${targetDate.toLocaleDateString()}</p></div></div><div class="text-right"><p class="text-xl font-bold">${formatCurrency(goal.amount)}</p>${onTrack ? `<span class="text-xs font-semibold px-2 py-1 rounded-full mt-1 bg-green-500/20 text-green-400">On Track!</span>` : ''}</div></div><div class="mt-4"><div class="flex justify-between text-sm mb-1"><span class="text-green-400">${formatCurrency(goal.saved)} Saved</span><span class="text-gray-400">${percent.toFixed(0)}%</span></div><div class="w-full bg-gray-700 rounded-full h-4"><div class="bg-green-600 h-4 rounded-full" style="width: ${percent}%"></div></div></div>${monthlyContribution > 0 ? `<p class="text-xs text-center mt-2 text-indigo-300">Save ${formatCurrency(monthlyContribution)}/month to stay on track.</p>` : (percent < 100 ? `<p class="text-xs text-center mt-2 text-red-400">Goal date has passed!</p>`: `<p class="text-xs text-center mt-2 text-green-400">Goal Complete!</p>`)}</div>`; }).join(''); lucide.createIcons(); };
            const renderPlanningPage = () => { const select = document.getElementById('planning-goal-select'); const content = document.getElementById('planning-content'); const noGoals = document.getElementById('no-planning-goals'); const activeGoals = goals.filter(g => g.type !== 'debt' && g.saved < g.amount); if(activeGoals.length === 0) { content.classList.add('hidden'); noGoals.classList.remove('hidden'); return; } content.classList.remove('hidden'); noGoals.classList.add('hidden'); select.innerHTML = activeGoals.map(g => `<option value="${g.id}">${g.name}</option>`).join(''); document.getElementById('extra-savings-slider').value = 0; updatePlanningChart(); };
            const updatePlanningChart = () => { const select = document.getElementById('planning-goal-select'); const slider = document.getElementById('extra-savings-slider'); const goal = goals.find(g => g.id == select.value); if(!goal) return; const extraSavings = parseFloat(slider.value); document.getElementById('extra-savings-value').textContent = formatCurrency(extraSavings); const now = new Date(); const targetDate = new Date(goal.date + 'T00:00:00'); const monthsToTarget = Math.max(1, (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth())); const needed = goal.amount - goal.saved; const idealMonthlySavings = needed / monthsToTarget; const projectedMonthlySavings = idealMonthlySavings + extraSavings; const monthsToProjectedTarget = needed > 0 ? Math.max(1, needed / projectedMonthlySavings) : 0; const projectedDate = new Date(now); projectedDate.setMonth(now.getMonth() + Math.ceil(monthsToProjectedTarget)); document.getElementById('planning-result-text').textContent = `You'll reach your goal on ${projectedDate.toLocaleDateString()}`; const ctx = document.getElementById('planning-chart').getContext('2d'); if(planningChart) planningChart.destroy(); const labels = Array.from({length: Math.ceil(monthsToTarget) + 1}, (_, i) => { const d = new Date(now); d.setMonth(now.getMonth() + i); return d.toLocaleDateString('en-us',{month:'short', year:'2-digit'}); }); const idealData = Array.from({length: labels.length}, (_, i) => Math.min(goal.amount, goal.saved + (idealMonthlySavings * i))); const projectedData = Array.from({length: labels.length}, (_, i) => { const val = goal.saved + (projectedMonthlySavings * i); return val > goal.amount ? goal.amount : val; }); planningChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Ideal Path', data: idealData, borderColor: 'rgba(255, 255, 255, 0.5)', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] }, { label: 'Projected Path', data: projectedData, borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 3, pointRadius: 0, tension: 0.1 }] }, options: { scales: { y: { ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } }); };
            const goalIcons = ['award', 'shopping-cart', 'car', 'graduation-cap', 'heart', 'home', 'plane', 'star', 'tree-palm'];
            const populateGoalIcons = () => { const selector = document.getElementById('goal-icon-selector'); selector.innerHTML = goalIcons.map((icon, index) => `<div><input type="radio" id="goal-icon-${icon}" name="icon" value="${icon}" class="hidden" ${index === 0 ? 'checked' : ''}><label for="goal-icon-${icon}" class="p-3 rounded-lg bg-gray-700 flex items-center justify-center"><i data-lucide="${icon}" class="w-6 h-6"></i></label></div>`).join(''); };
            const openGoalModal = (goalId = null) => { populateGoalIcons(); goalForm.reset(); const modalTitle = document.getElementById('goal-modal-title'); const deleteBtn = document.getElementById('delete-goal-btn'); if (goalId) { const goal = goals.find(g => g.id == goalId); if(!goal) return; modalTitle.textContent = 'Edit Goal'; deleteBtn.classList.remove('hidden'); document.getElementById('goal-id').value = goal.id; document.getElementById('goal-name').value = goal.name; document.getElementById('goal-amount').value = goal.amount; document.getElementById('goal-saved').value = goal.saved; document.getElementById('goal-date').value = goal.date; document.getElementById('goal-type').value = goal.type || 'savings'; if(goal.icon) document.querySelector(`input[name="icon"][value="${goal.icon}"]`).checked = true; } else { modalTitle.textContent = 'Add Goal'; deleteBtn.classList.add('hidden'); document.getElementById('goal-id').value = ''; const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); document.getElementById('goal-date').value = tomorrow.toISOString().split('T')[0]; } toggleModal(goalModal, true); lucide.createIcons(); };
            const handleGoalFormSubmit = (e) => { e.preventDefault(); const formData = new FormData(e.target); const id = formData.get('id'); const goalData = { name: formData.get('name'), amount: parseFloat(formData.get('amount')), saved: parseFloat(formData.get('saved')), date: formData.get('date'), type: formData.get('type'), icon: formData.get('icon') }; if (id) { const index = goals.findIndex(g => g.id == id); if (index > -1) goals[index] = {...goals[index], ...goalData}; showToast('Goal updated!'); } else { goals.push({ ...goalData, id: Date.now() }); showToast('Goal added!'); } if (goalData.type === 'debt' && goalData.saved >= goalData.amount) { showVictory(goalData.name); } saveData(); renderGoalsPage(); toggleModal(goalModal, false); };
            const handleDeleteGoal = () => { const id = document.getElementById('goal-id').value; goals = goals.filter(g => g.id != id); saveData(); renderGoalsPage(); toggleModal(goalModal, false); showToast('Goal deleted', 'error'); };
            const showVictory = (debtName) => { const modal = document.getElementById('victory-modal'); document.getElementById('victory-debt-name').textContent = debtName; toggleModal(modal, true); setTimeout(() => toggleModal(modal, false), 4000); };
            const openTransactionModal = (type = 'bill', transactionId = null) => {
                const modal = document.getElementById('add-transaction-modal');
                const form = document.getElementById('transaction-form');
                const modalTitle = document.getElementById('modal-title');
                const deleteBtn = document.getElementById('delete-btn');
                const categoryContainer = document.getElementById('category-container');
                
                form.reset();
                
                if (transactionId) {
                    const transaction = transactions.find(t => t.id == transactionId);
                    if (!transaction) return;
                    
                    modalTitle.textContent = 'Edit Transaction';
                    deleteBtn.classList.remove('hidden');
                    document.getElementById('transaction-id').value = transaction.id;
                    document.getElementById('transaction-type').value = transaction.type;
                    document.getElementById('transaction-description').value = transaction.description;
                    document.getElementById('transaction-amount').value = transaction.amount;
                    document.getElementById('transaction-date').value = transaction.date;
                    if (transaction.category) {
                        document.getElementById('transaction-category').value = transaction.category;
                    }
                } else {
                    modalTitle.textContent = 'Add Transaction';
                    deleteBtn.classList.add('hidden');
                    document.getElementById('transaction-id').value = '';
                    document.getElementById('transaction-type').value = type;
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('transaction-date').value = today;
                }
                
                // Show/hide category field based on transaction type
                if (document.getElementById('transaction-type').value === 'income') {
                    categoryContainer.style.display = 'none';
                } else {
                    categoryContainer.style.display = 'block';
                }
                
                toggleModal(modal, true);
            };
            const handleFormSubmit = (e) => { e.preventDefault(); const formData = new FormData(e.target); const id = formData.get('id'); const type = formData.get('type'); const transactionData = { type: type, description: formData.get('description'), amount: parseFloat(formData.get('amount')), date: formData.get('date'), category: type === 'income' ? null : formData.get('category') }; if (id) { const index = transactions.findIndex(t => t.id == id); if (index !== -1) transactions[index] = { ...transactions[index], ...transactionData }; showToast('Transaction updated!'); } else { transactions.push({ ...transactionData, id: Date.now(), status: type === 'income' ? 'paid' : 'unpaid' }); showToast('Transaction added!'); addXp(XP_VALUES.ADD_TRANSACTION); } saveData(); setActiveView('monthly'); toggleModal(document.getElementById('add-transaction-modal'), false); };
            const handleDelete = () => { const id = document.getElementById('transaction-id').value; if (!id) return; transactions = transactions.filter(t => t.id != id); saveData(); setActiveView('monthly'); toggleModal(document.getElementById('add-transaction-modal'), false); showToast('Transaction deleted!', 'error'); };
            const handleListClick = (e) => { const header = e.target.closest('.category-header'); const editBtn = e.target.closest('.edit-btn'); const paidBtn = e.target.closest('.toggle-paid-btn'); if (header) { const categoryKey = header.dataset.categoryKey; collapsedCategories[categoryKey] = !collapsedCategories[categoryKey]; saveData(); renderMonthlyTransactions(); } else if (editBtn) { openTransactionModal(null, editBtn.dataset.id); } else if (paidBtn) { const transaction = transactions.find(t => t.id == paidBtn.dataset.id); if (transaction) { if (transaction.status !== 'paid') addXp(XP_VALUES.PAY_BILL); transaction.status = transaction.status === 'paid' ? 'unpaid' : 'paid'; saveData(); renderMonthlyTransactions(); } } };
            const populateMonthsCheckboxes = () => { const monthsCheckboxList = document.getElementById('months-checkbox-list'); document.getElementById('copy-source-month').textContent = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(currentDate); monthsCheckboxList.innerHTML = ''; const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; monthNames.forEach((month, index) => { monthsCheckboxList.innerHTML += `<label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 cursor-pointer text-gray-300"><input type="checkbox" value="${index}" class="month-checkbox rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-600"><span>${month}</span></label>`; }); };
            const handleCopyMonthSubmit = (e) => { e.preventDefault(); const yearsToCopy = parseInt(document.getElementById('years-to-copy-input').value, 10) || 1; const sourceMonth = currentDate.getMonth(); const sourceYear = currentDate.getFullYear(); const sourceTransactions = transactions.filter(t => new Date(t.date + 'T00:00:00').getMonth() === sourceMonth && new Date(t.date + 'T00:00:00').getFullYear() === sourceYear); if (sourceTransactions.length === 0) { showToast("No transactions in the current month to copy.", 'error'); return; } const targetMonths = Array.from(document.querySelectorAll('.month-checkbox:checked')).map(cb => parseInt(cb.value)); if (targetMonths.length === 0) { showToast("Please select at least one month to copy to.", 'error'); return; } let newTransactions = []; for (let i = 0; i < yearsToCopy; i++) { const currentTargetYear = sourceYear + i; targetMonths.forEach(monthIndex => { if (currentTargetYear === sourceYear && monthIndex <= sourceMonth) { return; } sourceTransactions.forEach(t => { const sourceDate = new Date(t.date + 'T00:00:00'); let targetDate = new Date(currentTargetYear, monthIndex, sourceDate.getDate()); if (targetDate.getMonth() !== monthIndex) { targetDate = new Date(currentTargetYear, monthIndex + 1, 0); } const alreadyExists = transactions.some(et => new Date(et.date + 'T00:00:00').getTime() === targetDate.getTime() && et.description === t.description && et.amount === t.amount); if (!alreadyExists) { newTransactions.push({ ...t, id: Date.now() + Math.random(), date: targetDate.toISOString().split('T')[0], status: t.type === 'income' ? 'paid' : 'unpaid' }); } }); }); } if (newTransactions.length > 0) { transactions.push(...newTransactions); saveData(); showToast(`${newTransactions.length} transaction(s) copied!`); } else { showToast("No new transactions were copied (they may already exist).", 'error'); } toggleModal(document.getElementById('copy-month-modal'), false); };
            const handleCsvImport = (event) => { const file = event.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { transactionsToImport = []; const potentialHeaders = { date: ['Date', 'Transaction Date'], description: ['Transaction', 'Description', 'Name'], amount: ['Amount', 'Price'] }; const findHeader = (row, options) => { for (const option of options) { if (row.hasOwnProperty(option)) return option; } return null; }; const firstRow = results.data[0]; const dateHeader = findHeader(firstRow, potentialHeaders.date); const descriptionHeader = findHeader(firstRow, potentialHeaders.description); const amountHeader = findHeader(firstRow, potentialHeaders.amount); if (!dateHeader || !descriptionHeader || !amountHeader) { showToast('CSV headers not recognized. Expected Date, Transaction, Amount.', 'error'); return; } results.data.forEach(row => { const date = new Date(row[dateHeader]); const amount = parseFloat(row[amountHeader]); const description = row[descriptionHeader].trim(); if (isNaN(date.getTime()) || isNaN(amount) || !description) return; const transactionType = amount > 0 ? 'income' : 'bill'; const finalAmount = Math.abs(amount); transactionsToImport.push({ date: date.toISOString().split('T')[0], description: description, amount: finalAmount, type: transactionType, category: 'other', status: transactionType === 'income' ? 'paid' : 'unpaid' }); }); displayCsvConfirmation(transactionsToImport); } }); event.target.value = ''; };
            const displayCsvConfirmation = (records) => { if(records.length === 0) { showToast('No valid transactions found in CSV file.', 'error'); return; } document.getElementById('csv-record-count').textContent = records.length; const previewList = document.getElementById('csv-preview-list'); previewList.innerHTML = records.slice(0, 10).map(r => `<div class="text-xs text-gray-400 p-1 grid grid-cols-3 gap-2"><span>${r.date}</span><span class="truncate">${r.description}</span><span class="font-mono text-right ${r.type === 'income' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(r.amount)}</span></div>`).join(''); toggleModal(csvConfirmationModal, true); };
            const confirmCsvImport = () => { const newTransactions = transactionsToImport.map(t => ({...t, id: Date.now() + Math.random() })); transactions.push(...newTransactions); addXp(XP_VALUES.ADD_TRANSACTION * newTransactions.length); saveData(); showToast(`${newTransactions.length} transactions imported successfully!`); toggleModal(csvConfirmationModal, false); setActiveView('monthly'); };

            // --- EVENT LISTENERS ---
            transactionsList.addEventListener('click', handleListClick);
            openMenuBtns.forEach(btn => btn.addEventListener('click', () => toggleMenu(true)));
            closeMenuBtn.addEventListener('click', () => toggleMenu(false));
            menuOverlay.addEventListener('click', () => toggleMenu(false));
            document.getElementById('add-income-menu-btn').addEventListener('click', () => { toggleMenu(false); openTransactionModal('income'); });
            document.getElementById('add-bill-menu-btn').addEventListener('click', () => { toggleMenu(false); openTransactionModal('bill'); });
            document.getElementById('add-debt-menu-btn').addEventListener('click', () => { toggleMenu(false); openTransactionModal('debt'); });
            document.getElementById('learning-menu-btn').addEventListener('click', () => { toggleMenu(false); setActiveView('learning'); });
            document.getElementById('copy-month-btn').addEventListener('click', () => { populateMonthsCheckboxes(); toggleMenu(false); toggleModal(document.getElementById('copy-month-modal'), true); });
            overviewViewBtn.addEventListener('click', () => setActiveView('overview'));
            monthlyViewBtn.addEventListener('click', () => setActiveView('monthly'));
            yearlyViewBtn.addEventListener('click', () => setActiveView('yearly'));
            goalsViewBtn.addEventListener('click', () => setActiveView('goals'));
            planningViewBtn.addEventListener('click', () => setActiveView('planning'));
            document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderMonthlyTransactions(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderMonthlyTransactions(); });
            document.getElementById('prev-year-btn').addEventListener('click', () => { summaryYear--; renderYearlySummary(); });
            document.getElementById('next-year-btn').addEventListener('click', () => { summaryYear++; renderYearlySummary(); });
            document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('delete-btn').addEventListener('click', handleDelete);
            document.getElementById('close-modal-btn').addEventListener('click', () => toggleModal(document.getElementById('add-transaction-modal'), false));
            document.getElementById('cancel-modal-btn').addEventListener('click', () => toggleModal(document.getElementById('add-transaction-modal'), false));
            function toggleCategoryVisibility(transactionType) {
                toggleCategoryVisibility(e.target.value);
            };
            document.getElementById('close-copy-modal-btn').addEventListener('click', () => toggleModal(document.getElementById('copy-month-modal'), false));
            document.getElementById('cancel-copy-modal-btn').addEventListener('click', () => toggleModal(document.getElementById('copy-month-modal'), false));
            document.getElementById('copy-month-form').addEventListener('submit', handleCopyMonthSubmit);
            document.getElementById('select-all-months').addEventListener('change', (e) => { document.querySelectorAll('.month-checkbox:not(:disabled)').forEach(cb => { cb.checked = e.target.checked; }); });
            csvImporter.addEventListener('change', handleCsvImport);
            document.getElementById('confirm-csv-import-btn').addEventListener('click', confirmCsvImport);
            document.getElementById('cancel-csv-import-btn').addEventListener('click', () => toggleModal(csvConfirmationModal, false));
            addGoalBtn.addEventListener('click', () => openGoalModal());
            goalForm.addEventListener('submit', handleGoalFormSubmit);
            document.getElementById('close-goal-modal-btn').addEventListener('click', () => toggleModal(goalModal, false));
            document.getElementById('cancel-goal-modal-btn').addEventListener('click', () => toggleModal(goalModal, false));
            document.getElementById('delete-goal-btn').addEventListener('click', handleDeleteGoal);
            document.getElementById('goals-list').addEventListener('click', (e) => { const item = e.target.closest('.goal-item'); if(item) openGoalModal(parseFloat(item.dataset.id)); });
            document.getElementById('close-subscription-modal-btn').addEventListener('click', () => {
                userProfile.lastSubscriptionReview = new Date().toISOString();
                saveData();
                toggleModal(document.getElementById('subscription-review-modal'), false);
            });

            // --- INITIALIZATION ---
            updateProfileUI();
            setActiveView('overview');
            checkForSubscriptionReview();
        });
    </script>
</body>
</html>

